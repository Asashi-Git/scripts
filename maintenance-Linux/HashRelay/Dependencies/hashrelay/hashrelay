#!/usr/bin/env bash
# This is the agent that listen for the input of a user to lunch the dependencies
# scripts that make the full project work.
#
# Author: Decarnelle Samuel

# Ensure we are root
if [[ ${EUID:-$(id -u)} -ne 0 ]]; then
  echo "HashRelay must be run as root (use sudo)." >&2
  exit 1
fi

BACKUP_CONF="/usr/local/bin/HashRelay/backups-manager/backups.conf"

usage() {
  cat <<'USAGE'
HASHRELAY
Options:
  --config                     Change the configuration
  --add <path>                 Add a file/directory to backups
  --remove <path>              Remove a file/directory from backups
  --uninstall                  Uninstall the agent [!] Irreversible [!]
  -h|--help                    Show this help
USAGE
}

# =======================================================
# ADD FUNCTION
# =======================================================
add_file() {
  local input="$1"

  # No argument?
  if [[ -z "$input" ]]; then
    echo "[!] Missing argument: you must provide a file name."
    exit 1
  fi

  # Detect absolute vs relative path
  if [[ "$input" = /* ]]; then
    filepath="$input"
  else
    filepath="$(pwd)/$input"
  fi

  # Convert slashes to underscores
  name="${filepath//\//_}"

  # Create a variable line
  line="${name}=${filepath}"

  # Check existence
  if [[ -e "$filepath" ]]; then
    if grep -Fxq "$line" "$BACKUP_CONF"; then
      echo "[i] Entry already exists in $BACKUP_CONF, skipping."
    else
      printf '%s\n' "$line" >>"$BACKUP_CONF"
      printf '[+] Added entry %s to %s\n' "$line" "$BACKUP_CONF"
    fi
  else
    echo "[!] hashrelay cannot add $input, verify your file name or path"
    exit 1
  fi
}

# =======================================================
# REMOVE FUNCTION
# =======================================================
remove_file() {
  local input="$1"

  # No argument?
  if [[ -z "$input" ]]; then
    echo "[!] Missing argument: you must provide a file name."
    exit 1
  fi

  # Detect absolute vs relative path
  if [[ "$input" = /* ]]; then
    filepath="$input"
  else
    filepath="$(pwd)/$input"
  fi

  # Convert slashes to underscores
  name="${filepath//\//_}"

  # Create a variable line
  line="${name}=${filepath}"

  # Check if the line exists in the conf
  if grep -Fxq "$line" "$BACKUP_CONF"; then
    # -q: quiet mode
    # Remove the exact line
    grep -Fxv "$line" "$BACKUP_CONF" >"${BACKUP_CONF}.tmp"
    # -F: literal match
    # -x: match the entire line
    # -v: invert: output all non matching lines
    # This keeps everything except the line you want to delete
    mv "${BACKUP_CONF}.tmp" "$BACKUP_CONF"

    printf '[-] Removed entry %s from %s\n' "$line" "$BACKUP_CONF"
  else
    echo "[i] No matching entry found in $BACKUP_CONF, nothing to remove."
  fi
}

# =======================================================
# MAIN ARG PARSER
# =======================================================
ACTION=""
ARGUMENT=""

while [[ $# -gt 0 ]]; do
  case "$1" in
  --add)
    ACTION="add"
    shift
    ARGUMENT="$1"
    ;;
  --remove)
    ACTION="remove"
    shift
    ARGUMENT="$1"
    ;;
  --config)
    ACTION="config"
    ;;
  --uninstall)
    ACTION="uninstall"
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  *)
    # unknown argument
    if [[ -n "$ACTION" && -z "$ARGUMENT" ]]; then
      ARGUMENT="$1"
    else
      echo "[!] Unknown arg: $1"
      usage
      exit 1
    fi
    ;;
  esac
  shift
done

# =======================================================
# EXECUTE ACTION
# =======================================================
case "$ACTION" in
add)
  add_file "$ARGUMENT"
  ;;
config)
  exec sudo bash /usr/local/bin/HashRelay/hashrelay-client/hashrelay-client.sh
  ;;
remove)
  remove_file "$ARGUMENT"
  ;;
uninstall)
  exec sudo bash /usr/local/bin/HashRelay/uninstaller/uninstaller.sh
  ;;
"")
  usage
  ;;
esac
