#!/usr/bin/env bash
# This is the agent that listen for the input of a user to lunch the dependencies
# scripts that make the full project work.
#
# Author: Decarnelle Samuel

# Ensure we are root
if [[ ${EUID:-$(id -u)} -ne 0 ]]; then
  echo "HashRelay must be run as root (use sudo)." >&2
  exit 1
fi

BACKUP_CONF="/usr/local/bin/HashRelay/backups-manager/backups.conf"

usage() {
  cat <<'USAGE'
HASHRELAY
Options:
  --config                     Change the configuration
  --add <path>                 Add a file/directory to backups
  --remove <path>              Remove a file/directory from backups
  -h|--help                    Show this help
USAGE
}

# =======================================================
# ADD FUNCTION
# =======================================================
add_file() {
  local input="$1"

  # No argument?
  if [[ -z "$input" ]]; then
    echo "[!] Missing argument: you must provide a file name."
    exit 1
  fi

  # Detect absolute vs relative path
  if [[ "$input" = /* ]]; then
    filepath="$input"
  else
    filepath="$(pwd)/$input"
  fi

  # Convert slashes to underscores
  name="${filepath//\//_}"

  # Remove leading underscore
  #name="${name#_}"

  # Check existence
  if [[ -e "$filepath" ]]; then
    echo "hashrelay has added $filepath"
    echo "The name of the backup is $name"
    printf 'HashRelay added %s inside %s as: %s=%s\n' "$name" "$BACKUP_CONF" "$name" "$filepath"
    printf '%s=%s\n' "$name" "$filepath" >>"$BACKUP_CONF"
  else
    echo "hashrelay cannot add $input, verify your file name or path"
    exit 1
  fi
}

# =======================================================
# MAIN ARG PARSER
# =======================================================
ACTION=""
ARGUMENT=""

while [[ $# -gt 0 ]]; do
  case "$1" in
  --add)
    ACTION="add"
    shift
    ARGUMENT="$1"
    ;;
  --remove)
    ACTION="remove"
    shift
    ARGUMENT="$1"
    ;;
  --config)
    ACTION="config"
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  *)
    # unknown argument
    if [[ -n "$ACTION" && -z "$ARGUMENT" ]]; then
      ARGUMENT="$1"
    else
      echo "[!] Unknown arg: $1"
      usage
      exit 1
    fi
    ;;
  esac
  shift
done

# =======================================================
# EXECUTE ACTION
# =======================================================
case "$ACTION" in
add)
  add_file "$ARGUMENT"
  ;;
config)
  exec sudo bash /usr/local/bin/HashRelay/hashrelay-client/hashrelay-client.sh
  ;;
remove)
  echo "Remove not implemented yet"
  ;;
"")
  usage
  ;;
esac
